# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Load environment variables from .env file
Dotenv.load(File.join(File.dirname(__FILE__), '.env'))

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:mac)

platform :mac do

  desc "Build the macOS app"
  lane :build do
    xcodebuild(
      scheme: "OpenSuperWhisper",
      configuration: "Release",
      clean: true,
      build: true,
      destination: "platform=macOS,arch=arm64",
      xcargs: "CODE_SIGN_IDENTITY='' CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO MACOSX_DEPLOYMENT_TARGET=15.0",
      derivedDataPath: "build",
      formatter: "xcpretty --simple --color"
    )
  end

  desc "Create DMG"
  lane :create_dmg do
    # Ensure the app is built first
    build
    
    # Define paths
    app_path = "build/Build/Products/Release/OpenSuperWhisper.app"
    dmg_path = "build/OpenSuperWhisper.dmg"
    
    # Remove existing DMG if it exists
    sh("rm", "-f", dmg_path) if File.exist?(dmg_path)
    
    # Verify the app exists
    UI.user_error!("App not found at #{app_path}") unless File.exist?(app_path)
    
    # Create DMG using create-dmg with simpler settings
    sh("create-dmg",
      "--volname", "OpenSuperWhisper",
      "--window-size", "600", "400",
      "--icon-size", "128",
      "--app-drop-link", "450", "200",
      "--icon", "OpenSuperWhisper.app", "150", "200",
      dmg_path,
      app_path
    )
    
    UI.success("DMG created successfully at #{dmg_path}")
  end

  desc "Sign the app with your Developer ID"
  lane :sign do |options|
    # Use provided identity, env variable, or error out
    identity = options[:identity] || ENV["SIGNING_IDENTITY"]
    UI.user_error!("No signing identity provided! Set SIGNING_IDENTITY in .env file or provide via identity parameter") unless identity

    app_path = "build/Build/Products/Release/OpenSuperWhisper.app"
    
    # Verify the app exists
    UI.user_error!("App not found at #{app_path}") unless File.exist?(app_path)

    # Sign the app
    sh("codesign", 
      "--force", 
      "--sign", identity,
      "--deep", 
      "--timestamp",
      "--options", "runtime",
      app_path
    )

    # Verify signature
    sh("codesign", "--verify", "--verbose", app_path)
  end

  desc "Build, create DMG, and sign the app"
  lane :release do |options|
    build
    create_dmg
    sign(identity: options[:identity]) # Will use default if no identity provided
  end
end
