# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Load environment variables from .env file
Dotenv.load(File.join(File.dirname(__FILE__), '.env'))

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:mac)

platform :mac do

  desc "Build the macOS app"
  lane :build do
    xcodebuild(
      scheme: "OpenSuperWhisper",
      configuration: "Release",
      clean: true,
      build: true,
      destination: "platform=macOS,arch=arm64",
      xcargs: "MACOSX_DEPLOYMENT_TARGET=15.0 CODE_SIGN_IDENTITY='-' CODE_SIGN_INJECT_BASE_ENTITLEMENTS=NO CODE_SIGN_STYLE=Automatic",
      derivedDataPath: "build",
      formatter: "xcpretty --simple --color"
    )
  end

  desc "Create DMG"
  lane :create_dmg do
    # Ensure the app is built first
    build
    
    # Define paths
    app_path = "build/Build/Products/Release/OpenSuperWhisper.app"
    dmg_path = "build/OpenSuperWhisper.dmg"
    
    # Remove existing DMG if it exists
    sh("rm", "-f", dmg_path) if File.exist?(dmg_path)
    
    # Verify the app exists
    UI.user_error!("App not found at #{app_path}") unless File.exist?(app_path)
    
    # Create DMG using create-dmg with simpler settings
    sh("create-dmg",
      "--volname", "OpenSuperWhisper",
      "--window-size", "600", "400",
      "--icon-size", "128",
      "--app-drop-link", "450", "200",
      "--icon", "OpenSuperWhisper.app", "150", "200",
      dmg_path,
      app_path
    )
    
    UI.success("DMG created successfully at #{dmg_path}")
  end

  desc "Build and create DMG"
  lane :release do
    build
    create_dmg
  end
end
